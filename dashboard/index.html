---
layout: default
title: ëŒ€ì‹œë³´ë“œ - DMC íˆ¬ì–´ë§í¬
---

<style>
.dash-wrap{display:flex;min-height:calc(100vh - 70px)}
.dash-side{width:240px;background:var(--navy-dark);color:#fff;padding:24px 0;flex-shrink:0}
.dash-side h2{padding:0 20px;font-size:16px;margin-bottom:24px;color:var(--orange)}
.dash-side a{display:block;padding:12px 20px;color:rgba(255,255,255,.8);font-size:14px;font-weight:500;transition:background .2s}
.dash-side a:hover,.dash-side a.active{background:rgba(255,255,255,.1);color:#fff}
.dash-content{flex:1;padding:32px;background:var(--gray-50);overflow-y:auto}
.dash-title{font-size:24px;font-weight:900;color:var(--navy);margin-bottom:24px}
.inq-card{background:#fff;border:2px solid var(--gray-200);border-radius:12px;padding:20px;margin-bottom:12px;cursor:pointer;transition:border-color .2s}
.inq-card:hover{border-color:var(--navy)}
.inq-card h3{font-size:16px;font-weight:700;color:var(--navy);margin-bottom:4px}
.inq-card p{font-size:13px;color:var(--gray-700);margin-bottom:8px}
.inq-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700}
.inq-badge.open{background:#e8f5e9;color:#2e7d32}
.inq-badge.in-progress{background:#fff3e0;color:#e65100}
.inq-badge.closed{background:var(--gray-200);color:var(--gray-700)}
.inq-detail{background:#fff;border-radius:12px;padding:24px;border:2px solid var(--gray-200)}
.inq-detail h2{font-size:20px;font-weight:700;color:var(--navy);margin-bottom:16px}
.inq-meta{font-size:13px;color:var(--gray-700);margin-bottom:16px;line-height:1.8}
.chat-area{margin-top:20px;border-top:1px solid var(--gray-200);padding-top:16px}
.chat-msg{display:flex;margin-bottom:12px}
.chat-msg.mine{justify-content:flex-end}
.chat-bubble{max-width:70%;padding:12px 16px;border-radius:12px;font-size:14px;line-height:1.6}
.chat-msg:not(.mine) .chat-bubble{background:var(--gray-100);border-bottom-left-radius:4px}
.chat-msg.mine .chat-bubble{background:var(--navy);color:#fff;border-bottom-right-radius:4px}
.chat-author{font-size:11px;font-weight:700;color:var(--gray-500);margin-bottom:2px}
.chat-time{font-size:10px;color:var(--gray-500);margin-top:4px}
.chat-input{display:flex;gap:8px;margin-top:16px}
.chat-input input{flex:1;padding:10px 14px;border:1px solid var(--gray-300);border-radius:8px;font-family:inherit;font-size:14px}
.dash-empty{text-align:center;padding:60px 20px;color:var(--gray-500)}
.dash-empty .icon{font-size:48px;margin-bottom:12px}
.back-btn{background:none;border:none;color:var(--navy);font-weight:700;cursor:pointer;font-size:14px;margin-bottom:16px;padding:0}
.url-form{background:#fff;border:2px solid var(--gray-200);border-radius:12px;padding:24px;margin-bottom:20px}
.url-form h3{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:8px}
.url-form p{font-size:13px;color:var(--gray-500);margin-bottom:16px}
.url-form .input-row{display:flex;gap:8px}
.url-form input[type="url"]{flex:1;padding:12px 14px;border:1px solid var(--gray-300);border-radius:8px;font-family:inherit;font-size:14px}
.url-form input[type="url"]:focus{outline:none;border-color:var(--navy)}
.url-form button{padding:12px 24px;white-space:nowrap}
.req-card{background:#fff;border:2px solid var(--gray-200);border-radius:12px;padding:16px;margin-bottom:10px;transition:border-color .2s}
.req-card:hover{border-color:var(--navy)}
.req-card h4{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px;word-break:break-all}
.req-card .req-meta{font-size:12px;color:var(--gray-500)}
.req-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700}
.req-badge.pending{background:#fff3e0;color:#e65100}
.req-badge.processing{background:#e3f2fd;color:#1565c0}
.req-badge.done{background:#e8f5e9;color:#2e7d32}
.req-badge.error{background:#ffebee;color:#c62828}
.parsed-preview{margin-top:12px;padding:12px;background:var(--gray-50);border-radius:8px;font-size:13px;line-height:1.6}
.parsed-preview strong{color:var(--navy)}
@media(max-width:768px){.dash-wrap{flex-direction:column}.dash-side{width:100%;display:flex;overflow-x:auto;padding:12px}.dash-side h2{display:none}.dash-side a{white-space:nowrap;padding:8px 16px}.dash-content{padding:16px}.url-form .input-row{flex-direction:column}}
</style>

<div class="dash-wrap">
  <nav class="dash-side">
    <h2>ğŸ“‹ ëŒ€ì‹œë³´ë“œ</h2>
    <a href="#" class="active" id="navInquiries">ğŸ’¬ ë¬¸ì˜ ê´€ë¦¬</a>
    <a href="#" id="navProducts">ğŸ“¦ ìƒí’ˆ ë“±ë¡</a>
    <a href="#" id="navProfile">ğŸ‘¤ ë‚´ ì •ë³´</a>
  </nav>
  <div class="dash-content" id="dashContent">
    <div id="loadingState" style="text-align:center;padding:60px"><p>ë¡œë”© ì¤‘...</p></div>
  </div>
</div>

<script>
var baseUrl = window.BASE_URL || '/dmc-platform';

document.addEventListener('dmcAuthReady', function(e) {
  var u = e.detail;
  if (!u || !u.profile) {
    location.href = baseUrl + '/auth/login/?redirect=' + encodeURIComponent(location.pathname);
    return;
  }
  if (u.profile.status !== 'approved') {
    document.getElementById('dashContent').innerHTML =
      '<div class="dash-empty"><div class="icon">â³</div><h3>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</h3><p>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p></div>';
    return;
  }
  // DMC/adminë§Œ ìƒí’ˆ ë“±ë¡ íƒ­ í‘œì‹œ
  var prodNav = document.getElementById('navProducts');
  if (u.profile.role !== 'dmc' && u.profile.role !== 'admin') {
    prodNav.style.display = 'none';
  }
  loadInquiries();
});

document.getElementById('navInquiries').onclick = function(e){ e.preventDefault(); loadInquiries(); setActive(this); };
document.getElementById('navProducts').onclick = function(e){ e.preventDefault(); loadProducts(); setActive(this); };
document.getElementById('navProfile').onclick = function(e){ e.preventDefault(); loadProfile(); setActive(this); };

function setActive(el){
  document.querySelectorAll('.dash-side a').forEach(function(a){a.classList.remove('active')});
  el.classList.add('active');
}

function loadInquiries() {
  var u = window.DMC_USER;
  var content = document.getElementById('dashContent');
  content.innerHTML = '<h1 class="dash-title">ğŸ’¬ ë¬¸ì˜ ê´€ë¦¬</h1><div id="inqList"><p>ë¡œë”© ì¤‘...</p></div>';

  // ì „ì²´ ê°€ì ¸ì˜¨ í›„ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ (ë³µí•© ì¸ë±ìŠ¤ ë¶ˆí•„ìš”)
  db.collection('inquiries').orderBy('createdAt', 'desc').get().then(function(snap) {
    var list = document.getElementById('inqList');
    var docs = [];
    snap.forEach(function(doc) {
      var d = doc.data();
      // agencyëŠ” ë³¸ì¸ ë¬¸ì˜ë§Œ
      if (u.profile.role !== 'dmc' && u.profile.role !== 'admin' && d.agencyUid !== u.uid) return;
      docs.push({id: doc.id, data: d});
    });
    if (docs.length === 0) {
      list.innerHTML = '<div class="dash-empty"><div class="icon">ğŸ“­</div><p>ì•„ì§ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
      return;
    }
    var html = '';
    docs.forEach(function(item) {
      var doc = {id: item.id};
      var d = item.data;
      var date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '';
      var extra = (u.profile.role === 'dmc' || u.profile.role === 'admin') ? '<span style="font-size:12px;color:var(--navy);font-weight:600;margin-left:8px;">ğŸ“© ' + esc(d.agencyName) + '</span>' : '';
      html += '<div class="inq-card" onclick="viewInquiry(\'' + doc.id + '\')">' +
        '<h3>' + esc(d.tourTitle || d.subject) + '</h3>' +
        '<p>' + esc(d.subject) + '</p>' +
        '<span class="inq-badge ' + d.status + '">' + statusLabel(d.status) + '</span> ' +
        '<span style="font-size:12px;color:var(--gray-500)">' + date + '</span>' + extra + '</div>';
    });
    list.innerHTML = html;
  });
}

function viewInquiry(id) {
  var content = document.getElementById('dashContent');
  content.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';

  db.collection('inquiries').doc(id).get().then(function(doc) {
    var d = doc.data();
    var date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString('ko-KR') : '';
    var html = '<button class="back-btn" onclick="loadInquiries()">â† ëª©ë¡ìœ¼ë¡œ</button>' +
      '<div class="inq-detail"><h2>' + esc(d.tourTitle) + '</h2>' +
      '<div class="inq-meta"><strong>ì œëª©:</strong> ' + esc(d.subject) + '<br>' +
      '<strong>ë¬¸ì˜ì:</strong> ' + esc(d.agencyName) + ' (' + esc(d.agencyEmail) + ')<br>' +
      (d.dmcName ? '<strong>DMC:</strong> ' + esc(d.dmcName) + '<br>' : '') +
      '<strong>ìƒíƒœ:</strong> <span class="inq-badge ' + d.status + '">' + statusLabel(d.status) + '</span><br>' +
      '<strong>ì‘ì„±ì¼:</strong> ' + date + '</div>' +
      '<p>' + esc(d.message) + '</p>' +
      '<div class="chat-area"><h3 style="font-size:16px;font-weight:700;margin-bottom:12px">ğŸ’¬ ëŒ“ê¸€</h3>' +
      '<div id="commentList"><p>ë¡œë”© ì¤‘...</p></div>' +
      '<div class="chat-input"><input type="text" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key===\'Enter\')addComment(\'' + id + '\')">' +
      '<button class="btn btn-primary btn-sm" onclick="addComment(\'' + id + '\')">ì „ì†¡</button></div>' +
      '</div></div>';
    content.innerHTML = html;

    InquirySystem.getComments(id).then(function(snap) {
      var cl = document.getElementById('commentList');
      if (snap.empty) { cl.innerHTML = '<p style="color:var(--gray-500);font-size:13px">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
      var ch = '';
      snap.forEach(function(cdoc) {
        var c = cdoc.data();
        var mine = window.DMC_USER && c.authorUid === window.DMC_USER.uid;
        var t = c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleString('ko-KR') : '';
        ch += '<div class="chat-msg' + (mine ? ' mine' : '') + '"><div>' +
          '<div class="chat-author">' + esc(c.authorName) + ' (' + roleLabel(c.authorRole) + ')</div>' +
          '<div class="chat-bubble">' + esc(c.message) + '</div>' +
          '<div class="chat-time">' + t + '</div></div></div>';
      });
      cl.innerHTML = ch;
      cl.scrollTop = cl.scrollHeight;
    });
  });
}

function addComment(inquiryId) {
  var input = document.getElementById('commentInput');
  var msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  InquirySystem.addComment(inquiryId, msg).then(function() {
    viewInquiry(inquiryId);
  }).catch(function(err) { alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + err); });
}

function loadProfile() {
  var u = window.DMC_USER;
  var p = u.profile;
  var content = document.getElementById('dashContent');
  content.innerHTML = '<h1 class="dash-title">ğŸ‘¤ ë‚´ ì •ë³´</h1>' +
    '<div class="inq-detail">' +
    '<p><strong>íšŒì‚¬ëª…:</strong> ' + esc(p.companyNameKr) + ' (' + esc(p.companyNameEn) + ')</p>' +
    '<p><strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> ' + esc(p.businessNumber) + '</p>' +
    '<p><strong>ë‹´ë‹¹ì:</strong> ' + esc(p.contactName) + ' / ' + esc(p.position) + '</p>' +
    '<p><strong>ì´ë©”ì¼:</strong> ' + esc(p.email) + '</p>' +
    '<p><strong>ì „í™”:</strong> ' + esc(p.phone) + '</p>' +
    '<p><strong>ì›¹ì‚¬ì´íŠ¸:</strong> ' + esc(p.website || '-') + '</p>' +
    '<p><strong>ì—­í• :</strong> ' + roleLabel(p.role) + '</p>' +
    '<p><strong>ìƒíƒœ:</strong> <span class="inq-badge ' + p.status + '">' + statusLabel(p.status) + '</span></p>' +
    '</div>';
}

function loadProducts() {
  var u = window.DMC_USER;
  var content = document.getElementById('dashContent');
  var isDmc = u.profile.role === 'dmc' || u.profile.role === 'admin';
  
  content.innerHTML = '<h1 class="dash-title">ğŸ“¦ ìƒí’ˆ ë“±ë¡</h1>' +
    (isDmc ? '<div class="url-form">' +
      '<h3>ğŸ”— íˆ¬ì–´ URLë¡œ ìë™ ë“±ë¡</h3>' +
      '<p>íˆ¬ì–´ ìƒí’ˆ í˜ì´ì§€ URLì„ ì…ë ¥í•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•´ì„œ ìƒí’ˆ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>' +
      '<div class="input-row">' +
        '<input type="url" id="tourUrlInput" placeholder="https://example.com/tour/..." />' +
        '<button class="btn btn-primary" onclick="submitUrl()">ë¶„ì„ ìš”ì²­</button>' +
      '</div>' +
      '<div id="submitMsg" style="margin-top:8px;font-size:13px"></div>' +
    '</div>' : '') +
    '<div id="reqList"><p>ë¡œë”© ì¤‘...</p></div>';

  // parsed_toursì—ì„œ ë³¸ì¸ íˆ¬ì–´ ìƒíƒœ ì¡°íšŒ
  var tourStatusMap = {};
  db.collection('parsed_tours').get().then(function(tourSnap) {
    tourSnap.forEach(function(td) {
      var t = td.data();
      if (t.sourceUrl) tourStatusMap[t.sourceUrl] = {status: t.status, id: td.id};
    });
    return db.collection('url_requests').orderBy('createdAt', 'desc').limit(50).get();
  }).then(function(snap) {
    var list = document.getElementById('reqList');
    var docs = [];
    snap.forEach(function(doc) {
      var d = doc.data();
      if (u.profile.role !== 'admin' && d.submitterUid !== u.uid) return;
      docs.push({id: doc.id, data: d});
    });
    if (docs.length === 0) {
      list.innerHTML = '<div class="dash-empty"><div class="icon">ğŸ“¦</div><p>ë“±ë¡ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. URLì„ ì…ë ¥í•´ ì²« ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p></div>';
      return;
    }
    var html = '';
    docs.forEach(function(item) {
      var doc = {id: item.id};
      var d = item.data;
      var date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString('ko-KR') : '';
      var preview = '';
      if (d.status === 'done' && d.parsedData) {
        var p = d.parsedData;
        preview = '<div class="parsed-preview">' +
          '<strong>' + esc(p.tourName || '') + '</strong><br>' +
          (p.destination ? 'ğŸ“ ' + esc(p.destination) + '<br>' : '') +
          (p.duration ? 'â± ' + esc(p.duration) + '<br>' : '') +
          (p.price ? 'ğŸ’° ' + esc(p.price) : '') +
          '</div>';
      }
      if (d.status === 'error' && d.errorMsg) {
        preview = '<div class="parsed-preview" style="color:#c62828">âŒ ' + esc(d.errorMsg) + '</div>';
      }
      var tourStatus = '';
      var matched = d.url ? tourStatusMap[d.url] : null;
      if (matched) {
        tourStatus = '<span class="req-badge ' + matched.status + '" style="margin-left:6px">' + tourStatusLabel(matched.status) + '</span>';
      } else if (d.status === 'done') {
        tourStatus = '<span class="req-badge pending" style="margin-left:6px">â³ ìŠ¹ì¸ëŒ€ê¸°</span>';
      }
      html += '<div class="req-card">' +
        '<div style="display:flex;justify-content:space-between;align-items:start">' +
          '<div style="flex:1"><h4>ğŸ”— ' + esc(d.url) + '</h4>' +
          '<div class="req-meta">' +
            '<span class="req-badge ' + d.status + '">' + reqStatusLabel(d.status) + '</span>' + tourStatus + ' Â· ' + date +
          '</div>' + preview + '</div>' +
          '<button onclick="event.stopPropagation();deleteRequest(\'' + doc.id + '\')" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--gray-500);padding:4px 8px" title="ì‚­ì œ">ğŸ—‘ï¸</button>' +
        '</div></div>';
    });
    list.innerHTML = html;
  }).catch(function(err) {
    console.error('loadProducts error:', err);
    document.getElementById('reqList').innerHTML = '<p style="color:#c62828">ì˜¤ë¥˜: ' + err.message + '</p>';
  });
}

function submitUrl() {
  var input = document.getElementById('tourUrlInput');
  var msg = document.getElementById('submitMsg');
  var url = input.value.trim();
  
  if (!url) { msg.innerHTML = '<span style="color:#c62828">URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>'; return; }
  if (!url.match(/^https?:\/\/.+/)) { msg.innerHTML = '<span style="color:#c62828">ì˜¬ë°”ë¥¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>'; return; }
  
  var u = window.DMC_USER;
  msg.innerHTML = 'â³ ì œì¶œ ì¤‘...';
  
  db.collection('url_requests').add({
    url: url,
    submitterUid: u.uid,
    submitterName: u.profile.companyNameKr || u.profile.contactName || '',
    submitterEmail: u.profile.email || '',
    status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(function() {
    input.value = '';
    msg.innerHTML = '<span style="color:#2e7d32">âœ… ì œì¶œ ì™„ë£Œ! AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span>';
    setTimeout(function(){ loadProducts(); }, 1500);
  }).catch(function(err) {
    msg.innerHTML = '<span style="color:#c62828">ì˜¤ë¥˜: ' + err.message + '</span>';
  });
}

function reqStatusLabel(s) {
  return {pending:'â³ ëŒ€ê¸°',processing:'ğŸ”„ ë¶„ì„ì¤‘',done:'âœ… íŒŒì‹±ì™„ë£Œ',error:'âŒ ì‹¤íŒ¨'}[s] || s;
}

function tourStatusLabel(s) {
  return {pending:'â³ ìŠ¹ì¸ëŒ€ê¸°',approved:'âœ… ìŠ¹ì¸ë¨',rejected:'âŒ ê±°ì ˆë¨'}[s] || s;
}

function deleteRequest(reqId) {
  if (!confirm('ì´ ë“±ë¡ ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  db.collection('url_requests').doc(reqId).delete().then(function() {
    loadProducts();
  }).catch(function(err) {
    alert('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
  });
}

function statusLabel(s){return{open:'ì ‘ìˆ˜',
'in-progress':'ì§„í–‰ì¤‘',closed:'ì™„ë£Œ',pending:'ëŒ€ê¸°',approved:'ìŠ¹ì¸',rejected:'ê±°ì ˆ'}[s]||s}
function roleLabel(r){return{agency:'ì—¬í–‰ì‚¬',dmc:'DMC',admin:'ê´€ë¦¬ì'}[r]||r}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
</script>
