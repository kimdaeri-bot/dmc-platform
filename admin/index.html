---
layout: default
title: ë°±ì˜¤í”¼ìŠ¤ - DMC íˆ¬ì–´ë§í¬
---

<style>
.admin-wrap{max-width:var(--max-width);margin:0 auto;padding:32px 20px}
.admin-title{font-size:28px;font-weight:900;color:var(--navy);margin-bottom:24px}
.admin-tabs{display:flex;gap:4px;border-bottom:2px solid var(--gray-200);margin-bottom:24px}
.admin-tab{padding:12px 24px;font-size:15px;font-weight:700;color:var(--gray-700);cursor:pointer;border:none;background:none;border-bottom:3px solid transparent;transition:all .2s}
.admin-tab.active{color:var(--navy);border-bottom-color:var(--orange)}
.admin-tab:hover{color:var(--navy)}
.admin-panel{display:none}.admin-panel.active{display:block}
.member-table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
.member-table th{background:var(--navy);color:#fff;padding:12px 16px;text-align:left;font-size:13px;font-weight:700}
.member-table td{padding:12px 16px;border-bottom:1px solid var(--gray-200);font-size:14px}
.member-table tr:hover td{background:var(--gray-50)}
.action-btn{padding:6px 14px;border-radius:6px;border:none;font-size:12px;font-weight:700;cursor:pointer;margin-right:4px}
.btn-approve{background:#e8f5e9;color:#2e7d32}.btn-approve:hover{background:#c8e6c9}
.btn-reject{background:#ffebee;color:#c62828}.btn-reject:hover{background:#ffcdd2}
.btn-status{padding:4px 10px;border-radius:6px;border:1px solid var(--gray-300);font-size:12px;cursor:pointer;background:#fff}
.sub-tabs{display:flex;gap:8px;margin-bottom:16px}
.sub-tab{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid var(--gray-200);background:#fff;color:var(--gray-700)}
.sub-tab.active{border-color:var(--navy);color:var(--navy);background:#e8eaf6}
.admin-empty{text-align:center;padding:40px;color:var(--gray-500)}
.inq-badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700}
.inq-badge.open{background:#e8f5e9;color:#2e7d32}
.inq-badge.in-progress{background:#fff3e0;color:#e65100}
.inq-badge.closed{background:var(--gray-200);color:var(--gray-700)}
/* Inquiry Detail & Comments */
.inq-detail{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:24px;margin-bottom:24px}
.inq-detail h2{font-size:20px;color:var(--navy);margin:0 0 8px}
.inq-meta{font-size:13px;color:var(--gray-500);margin-bottom:16px}
.inq-body{font-size:14px;line-height:1.7;padding:16px;background:var(--gray-50);border-radius:8px;margin-bottom:24px;white-space:pre-wrap}
.comment-thread{max-height:400px;overflow-y:auto;padding:16px;background:var(--gray-50);border-radius:8px;margin-bottom:16px}
.comment-bubble{max-width:70%;padding:12px 16px;border-radius:16px;margin-bottom:12px;font-size:14px;line-height:1.5;position:relative}
.comment-bubble.left{background:#fff;border:1px solid var(--gray-200);margin-right:auto;border-bottom-left-radius:4px}
.comment-bubble.right{background:var(--navy);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
.comment-bubble .cb-name{font-size:11px;font-weight:700;margin-bottom:4px;opacity:.7}
.comment-bubble .cb-time{font-size:10px;opacity:.5;margin-top:4px}
.comment-form{display:flex;gap:8px}
.comment-form textarea{flex:1;padding:12px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px;resize:none;min-height:48px}
.comment-form button{padding:12px 24px;background:var(--navy);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer}
.comment-form button:hover{opacity:.9}
.btn-back{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:1px solid var(--gray-300);border-radius:8px;background:#fff;font-size:13px;font-weight:600;cursor:pointer;color:var(--gray-700);margin-bottom:16px}
.btn-back:hover{background:var(--gray-50)}
@media(max-width:768px){.member-table{font-size:12px}.member-table th,.member-table td{padding:8px}.admin-tabs{overflow-x:auto}.admin-tab{white-space:nowrap;padding:10px 16px;font-size:13px}.comment-bubble{max-width:85%}}
</style>

<div class="admin-wrap">
  <h1 class="admin-title">ğŸ¢ ë°±ì˜¤í”¼ìŠ¤</h1>
  <div id="adminLoading" style="text-align:center;padding:60px"><p>ê¶Œí•œ í™•ì¸ ì¤‘...</p></div>
  <div id="adminMain" style="display:none">
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('members',this)">ğŸ‘¥ íšŒì› ê´€ë¦¬</button>
      <button class="admin-tab" onclick="switchTab('inquiries',this)">ğŸ’¬ ë¬¸ì˜ ê´€ë¦¬</button>
      <button class="admin-tab" onclick="switchTab('products',this)">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</button>
    </div>
    <div class="admin-panel active" id="panel-members"></div>
    <div class="admin-panel" id="panel-inquiries"></div>
    <div class="admin-panel" id="panel-products"></div>
  </div>
</div>

<script>
var baseUrl = window.BASE_URL || '/dmc-platform';

document.addEventListener('dmcAuthReady', function(e) {
  var u = e.detail;
  if (!u || !u.profile || u.profile.role !== 'admin') {
    document.getElementById('adminLoading').innerHTML =
      '<p style="color:#c62828">â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p><a href="' + baseUrl + '/" class="btn btn-outline btn-sm" style="margin-top:16px">í™ˆìœ¼ë¡œ</a>';
    return;
  }
  document.getElementById('adminLoading').style.display = 'none';
  document.getElementById('adminMain').style.display = 'block';
  loadMembers();
  loadAdminInquiries();
  loadProducts();
});

function switchTab(name, btn) {
  document.querySelectorAll('.admin-tab').forEach(function(t){t.classList.remove('active')});
  document.querySelectorAll('.admin-panel').forEach(function(p){p.classList.remove('active')});
  btn.classList.add('active');
  document.getElementById('panel-' + name).classList.add('active');
}

// === Members ===
var memberFilter = 'pending';
function loadMembers() {
  var panel = document.getElementById('panel-members');
  panel.innerHTML = '<div class="sub-tabs">' +
    '<button class="sub-tab' + (memberFilter==='pending'?' active':'') + '" onclick="memberFilter=\'pending\';loadMembers()">â³ ìŠ¹ì¸ ëŒ€ê¸°</button>' +
    '<button class="sub-tab' + (memberFilter==='approved'?' active':'') + '" onclick="memberFilter=\'approved\';loadMembers()">âœ… ìŠ¹ì¸ë¨</button>' +
    '<button class="sub-tab' + (memberFilter==='all'?' active':'') + '" onclick="memberFilter=\'all\';loadMembers()">ğŸ“‹ ì „ì²´</button>' +
    '</div><div id="memberList"><p>ë¡œë”© ì¤‘...</p></div>';

  var q = db.collection('users');
  if (memberFilter !== 'all') q = q.where('status', '==', memberFilter);

  q.get().then(function(snap) {
    var list = document.getElementById('memberList');
    if (snap.empty) { list.innerHTML = '<div class="admin-empty"><p>íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>'; return; }
    var html = '<table class="member-table"><thead><tr><th>íšŒì‚¬ëª…</th><th>ë‹´ë‹¹ì</th><th>ì´ë©”ì¼</th><th>ì—­í• </th><th>ìƒíƒœ</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
    snap.forEach(function(doc) {
      var d = doc.data();
      var date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '-';
      var role = {agency:'ì—¬í–‰ì‚¬',dmc:'DMC',admin:'ê´€ë¦¬ì'}[d.role] || d.role;
      var status = {pending:'ëŒ€ê¸°',approved:'ìŠ¹ì¸',rejected:'ê±°ì ˆ'}[d.status] || d.status;
      html += '<tr><td>' + esc(d.companyNameKr) + '</td><td>' + esc(d.contactName) + '</td><td>' + esc(d.email) + '</td>' +
        '<td>' + role + '</td><td>' + status + '</td><td>' + date + '</td><td>';
      if (d.status === 'pending') {
        html += '<button class="action-btn btn-approve" onclick="approveMember(\'' + doc.id + '\')">ìŠ¹ì¸</button>' +
          '<button class="action-btn btn-reject" onclick="rejectMember(\'' + doc.id + '\')">ê±°ì ˆ</button>';
      } else if (d.status === 'approved') {
        html += '<span style="color:var(--gray-500);font-size:12px">ìŠ¹ì¸ë¨</span>';
      }
      html += '</td></tr>';
    });
    html += '</tbody></table>';
    list.innerHTML = html;
  });
}

function approveMember(uid) {
  if (!confirm('ì´ íšŒì›ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  db.collection('users').doc(uid).update({
    status: 'approved',
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(function(){ loadMembers(); });
}

function rejectMember(uid) {
  if (!confirm('ì´ íšŒì›ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  db.collection('users').doc(uid).update({
    status: 'rejected',
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(function(){ loadMembers(); });
}

// === Inquiries ===
function loadAdminInquiries() {
  var panel = document.getElementById('panel-inquiries');
  panel.innerHTML = '<div id="adminInqList"><p>ë¡œë”© ì¤‘...</p></div>';

  db.collection('inquiries').orderBy('createdAt', 'desc').get().then(function(snap) {
    var list = document.getElementById('adminInqList');
    if (snap.empty) { list.innerHTML = '<div class="admin-empty"><p>ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>'; return; }
    var html = '<table class="member-table"><thead><tr><th>íˆ¬ì–´</th><th>ì œëª©</th><th>ë¬¸ì˜ì</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
    snap.forEach(function(doc) {
      var d = doc.data();
      var date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '-';
      html += '<tr style="cursor:pointer" onclick="openInquiryDetail(\'' + doc.id + '\')">' +
        '<td>' + esc(d.tourTitle) + '</td><td>' + esc(d.subject) + '</td><td>' + esc(d.agencyName) + '</td>' +
        '<td><span class="inq-badge ' + d.status + '">' + statusLabel(d.status) + '</span></td><td>' + date + '</td>' +
        '<td><select class="btn-status" onclick="event.stopPropagation()" onchange="changeInqStatus(\'' + doc.id + '\',this.value)">' +
        '<option value="open"' + (d.status==='open'?' selected':'') + '>ì ‘ìˆ˜</option>' +
        '<option value="in-progress"' + (d.status==='in-progress'?' selected':'') + '>ì§„í–‰ì¤‘</option>' +
        '<option value="closed"' + (d.status==='closed'?' selected':'') + '>ì™„ë£Œ</option></select></td></tr>';
    });
    html += '</tbody></table>';
    list.innerHTML = html;
  });
}

function openInquiryDetail(inqId) {
  var panel = document.getElementById('panel-inquiries');
  panel.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';

  db.collection('inquiries').doc(inqId).get().then(function(doc) {
    if (!doc.exists) { panel.innerHTML = '<p>ë¬¸ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
    var d = doc.data();
    var date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString('ko-KR') : '-';

    var html = '<button class="btn-back" onclick="loadAdminInquiries()">â† ëª©ë¡ìœ¼ë¡œ</button>';
    html += '<div class="inq-detail">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center">';
    html += '<h2>' + esc(d.subject) + '</h2>';
    html += '<span class="inq-badge ' + d.status + '">' + statusLabel(d.status) + '</span></div>';
    html += '<div class="inq-meta">ë¬¸ì˜ì: ' + esc(d.agencyName) + ' | íˆ¬ì–´: ' + esc(d.tourTitle) + ' | ' + date + '</div>';
    html += '<div class="inq-body">' + esc(d.message) + '</div>';
    html += '</div>';

    html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px">ğŸ’¬ ëŒ“ê¸€</h3>';
    html += '<div class="comment-thread" id="commentThread"><p style="text-align:center;color:var(--gray-500)">ëŒ“ê¸€ ë¡œë”© ì¤‘...</p></div>';
    html += '<div class="comment-form"><textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>';
    html += '<button onclick="postComment(\'' + inqId + '\')">ì „ì†¡</button></div>';

    panel.innerHTML = html;
    loadComments(inqId);
  });
}

function loadComments(inqId) {
  var thread = document.getElementById('commentThread');
  db.collection('inquiries').doc(inqId).collection('comments').orderBy('createdAt', 'asc').get().then(function(snap) {
    if (snap.empty) { thread.innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:20px">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
    var html = '';
    snap.forEach(function(doc) {
      var c = doc.data();
      var isAdmin = c.authorRole === 'admin';
      var side = isAdmin ? 'right' : 'left';
      var time = c.createdAt ? new Date(c.createdAt.seconds ? c.createdAt.seconds * 1000 : c.createdAt).toLocaleString('ko-KR') : '';
      html += '<div class="comment-bubble ' + side + '">';
      html += '<div class="cb-name">' + esc(c.authorName) + (isAdmin ? ' (ê´€ë¦¬ì)' : '') + '</div>';
      html += esc(c.message);
      html += '<div class="cb-time">' + time + '</div></div>';
    });
    thread.innerHTML = html;
    thread.scrollTop = thread.scrollHeight;
  });
}

function postComment(inqId) {
  var input = document.getElementById('commentInput');
  var msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  var user = auth.currentUser;
  db.collection('inquiries').doc(inqId).collection('comments').add({
    authorUid: user.uid,
    authorName: 'ê´€ë¦¬ì',
    authorRole: 'admin',
    message: msg,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(function() {
    loadComments(inqId);
  });
}

function changeInqStatus(id, status) {
  InquirySystem.updateInquiryStatus(id, status).then(function() {
    loadAdminInquiries();
  });
}

function statusLabel(s){return{open:'ì ‘ìˆ˜','in-progress':'ì§„í–‰ì¤‘',closed:'ì™„ë£Œ'}[s]||s}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}

// === Products (parsed_tours) ===
var productFilter = 'pending';
var productView = 'list'; // list | detail | add

function loadProducts() {
  productView = 'list';
  var panel = document.getElementById('panel-products');
  panel.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">' +
    '<div class="sub-tabs">' +
    '<button class="sub-tab' + (productFilter==='pending'?' active':'') + '" onclick="productFilter=\'pending\';loadProducts()">â³ ê²€í†  ëŒ€ê¸°</button>' +
    '<button class="sub-tab' + (productFilter==='approved'?' active':'') + '" onclick="productFilter=\'approved\';loadProducts()">âœ… ìŠ¹ì¸ë¨</button>' +
    '<button class="sub-tab' + (productFilter==='rejected'?' active':'') + '" onclick="productFilter=\'rejected\';loadProducts()">âŒ ê±°ì ˆ</button>' +
    '<button class="sub-tab' + (productFilter==='all'?' active':'') + '" onclick="productFilter=\'all\';loadProducts()">ğŸ“‹ ì „ì²´</button>' +
    '</div>' +
    '<button class="action-btn btn-approve" style="padding:10px 20px;font-size:14px" onclick="showAddProduct()">â• ìˆ˜ë™ ì¶”ê°€</button>' +
    '</div><div id="productList"><p>ë¡œë”© ì¤‘...</p></div>';

  db.collection('parsed_tours').get().then(function(snap) {
    var list = document.getElementById('productList');
    if (!list) return;
    var docs = [];
    snap.forEach(function(doc) {
      var d = doc.data(); d._id = doc.id;
      if (productFilter === 'all' || d.status === productFilter) docs.push(d);
    });
    // ìµœì‹ ìˆœ ì •ë ¬ (createdAt íƒ€ì… ìœ ì—°í•˜ê²Œ)
    docs.sort(function(a,b) {
      var ta = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds*1000 : new Date(a.createdAt).getTime()) : 0;
      var tb = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds*1000 : new Date(b.createdAt).getTime()) : 0;
      return tb - ta;
    });
    if (docs.length === 0) { list.innerHTML = '<div class="admin-empty"><p>ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p></div>'; return; }
    var statusMap = {pending:'â³ ëŒ€ê¸°',approved:'âœ… ìŠ¹ì¸',rejected:'âŒ ê±°ì ˆ'};
    var html = '<table class="member-table"><thead><tr><th>ìƒí’ˆëª…</th><th>ëª©ì ì§€</th><th>ê¸°ê°„</th><th>ê°€ê²©</th><th>DMC</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
    docs.forEach(function(d) {
      var name = d.title || d.tourName || '-';
      var dest = (d.countryName ? d.countryName + ' ' : '') + (d.city || d.destination || '');
      var price = d.priceFrom ? '$' + d.priceFrom : (d.price || '-');
      var dmc = d.operatorName || d.submitterName || d.dmcName || '-';
      var date = d.createdAt ? new Date(d.createdAt.seconds ? d.createdAt.seconds*1000 : d.createdAt).toLocaleDateString('ko-KR') : '-';
      html += '<tr style="cursor:pointer" onclick="openProductDetail(\'' + d._id + '\')">' +
        '<td>' + esc(name) + '</td><td>' + esc(dest) + '</td><td>' + esc(d.duration||'-') + '</td>' +
        '<td>' + esc(price) + '</td><td>' + esc(dmc) + '</td>' +
        '<td>' + (statusMap[d.status]||d.status) + '</td><td>' + date + '</td>' +
        '<td><div onclick="event.stopPropagation()">';
      if (d.status !== 'approved') html += '<button class="action-btn btn-approve" onclick="quickProductAction(\'' + d._id + '\',\'approved\')">ìŠ¹ì¸</button>';
      if (d.status !== 'rejected') html += '<button class="action-btn btn-reject" onclick="quickProductAction(\'' + d._id + '\',\'rejected\')">ê±°ì ˆ</button>';
      html += '</div></td></tr>';
    });
    html += '</tbody></table>';
    list.innerHTML = html;
  }).catch(function(e){ document.getElementById('productList').innerHTML = '<p style="color:red">ì˜¤ë¥˜: '+e.message+'</p>'; });
}

function quickProductAction(id, status) {
  if (!confirm(status==='approved'?'ì´ ìƒí’ˆì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?':'ì´ ìƒí’ˆì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  db.collection('parsed_tours').doc(id).update({status:status,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}).then(function(){loadProducts();});
}

function openProductDetail(id) {
  var panel = document.getElementById('panel-products');
  panel.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';
  db.collection('parsed_tours').doc(id).get().then(function(doc) {
    if (!doc.exists) { panel.innerHTML = '<p>ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
    var d = doc.data();
    var fields = [
      {key:'title',label:'ìƒí’ˆëª…',type:'input'},
      {key:'countryName',label:'êµ­ê°€',type:'input'},
      {key:'city',label:'ë„ì‹œ',type:'input'},
      {key:'continent',label:'ëŒ€ë¥™ (asia/europe/americas/oceania/africa/middle-east)',type:'input'},
      {key:'category',label:'ì¹´í…Œê³ ë¦¬',type:'input'},
      {key:'duration',label:'ê¸°ê°„',type:'input'},
      {key:'priceFrom',label:'ìµœì €ê°€ (USD)',type:'input'},
      {key:'operatorName',label:'DMC ìš´ì˜ì‚¬',type:'input'},
      {key:'image',label:'ì´ë¯¸ì§€ (ì´ëª¨ì§€ ë˜ëŠ” URL)',type:'input'},
      {key:'groupSize',label:'ìµœëŒ€ ì¸ì›',type:'input'},
      {key:'description',label:'ì„¤ëª…',type:'textarea'},
      {key:'highlights',label:'í•˜ì´ë¼ì´íŠ¸ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
      {key:'itinerary',label:'ì¼ì • (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
      {key:'included',label:'í¬í•¨ ì‚¬í•­ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
      {key:'excluded',label:'ë¶ˆí¬í•¨ ì‚¬í•­ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
      {key:'sourceUrl',label:'ì›ë³¸ URL',type:'input'}
    ];
    var statusMap = {pending:'â³ ê²€í†  ëŒ€ê¸°',approved:'âœ… ìŠ¹ì¸ë¨',rejected:'âŒ ê±°ì ˆ'};
    var html = '<button class="btn-back" onclick="loadProducts()">â† ëª©ë¡ìœ¼ë¡œ</button>';
    html += '<div class="inq-detail"><h2>' + esc(d.title || d.tourName || '(ì œëª© ì—†ìŒ)') + '</h2>';
    html += '<div class="inq-meta">ìƒíƒœ: ' + (statusMap[d.status]||d.status) + '</div>';
    html += '<div style="display:grid;gap:16px;margin-top:16px">';
    fields.forEach(function(f) {
      var val = d[f.key];
      if (Array.isArray(val)) {
        val = val.map(function(item) {
          if (typeof item === 'object' && item.day) return 'Day ' + item.day + ': ' + (item.title||'') + ' - ' + (item.description||'');
          return typeof item === 'string' ? item : JSON.stringify(item);
        }).join('\n');
      }
      val = val != null ? String(val) : '';
      html += '<div><label style="font-size:13px;font-weight:700;color:var(--gray-700);display:block;margin-bottom:4px">' + f.label + '</label>';
      if (f.type === 'textarea') {
        html += '<textarea id="pf_'+f.key+'" style="width:100%;min-height:80px;padding:10px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px;font-family:inherit;resize:vertical">' + esc(val) + '</textarea>';
      } else {
        html += '<input id="pf_'+f.key+'" type="text" value="' + esc(val).replace(/"/g,'&quot;') + '" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px">';
      }
      html += '</div>';
    });
    html += '</div>';
    html += '<div style="display:flex;gap:8px;margin-top:24px">';
    html += '<button class="action-btn btn-approve" style="padding:12px 24px;font-size:14px" onclick="saveProduct(\''+doc.id+'\',\'approved\')">âœ… ìŠ¹ì¸</button>';
    html += '<button class="action-btn btn-reject" style="padding:12px 24px;font-size:14px" onclick="saveProduct(\''+doc.id+'\',\'rejected\')">âŒ ê±°ì ˆ</button>';
    html += '<button class="action-btn" style="padding:12px 24px;font-size:14px;background:#e3f2fd;color:#1565c0" onclick="saveProduct(\''+doc.id+'\',null)">ğŸ’¾ ì €ì¥ (ìƒíƒœ ìœ ì§€)</button>';
    html += '</div></div>';
    panel.innerHTML = html;
  });
}

function saveProduct(id, newStatus) {
  var fields = ['title','countryName','city','continent','category','duration','priceFrom','operatorName','image','groupSize','description','highlights','itinerary','included','excluded','sourceUrl'];
  var data = {updatedAt: firebase.firestore.FieldValue.serverTimestamp()};
  fields.forEach(function(f) {
    var el = document.getElementById('pf_'+f);
    if (!el) return;
    var v = el.value;
    if (['highlights','itinerary','included','excluded'].indexOf(f) >= 0) {
      data[f] = v.split('\n').filter(function(l){return l.trim();});
    } else if (f === 'priceFrom' || f === 'groupSize') {
      data[f] = parseInt(v) || 0;
    } else {
      data[f] = v;
    }
  });
  if (newStatus) data.status = newStatus;
  db.collection('parsed_tours').doc(id).update(data).then(function() {
    alert(newStatus==='approved'?'ìŠ¹ì¸ ì™„ë£Œ!':newStatus==='rejected'?'ê±°ì ˆ ì²˜ë¦¬ë¨':'ì €ì¥ ì™„ë£Œ!');
    loadProducts();
  }).catch(function(e){alert('ì˜¤ë¥˜: '+e.message);});
}

function showAddProduct() {
  var panel = document.getElementById('panel-products');
  var fields = [
    {key:'title',label:'ìƒí’ˆëª…',type:'input'},
    {key:'countryName',label:'êµ­ê°€',type:'input'},
    {key:'city',label:'ë„ì‹œ',type:'input'},
    {key:'continent',label:'ëŒ€ë¥™ (asia/europe/americas/oceania/africa/middle-east)',type:'input'},
    {key:'category',label:'ì¹´í…Œê³ ë¦¬',type:'input'},
    {key:'duration',label:'ê¸°ê°„',type:'input'},
    {key:'priceFrom',label:'ìµœì €ê°€ (USD)',type:'input'},
    {key:'operatorName',label:'DMC ìš´ì˜ì‚¬',type:'input'},
    {key:'image',label:'ì´ë¯¸ì§€ (ì´ëª¨ì§€ ë˜ëŠ” URL)',type:'input'},
    {key:'description',label:'ì„¤ëª…',type:'textarea'},
    {key:'highlights',label:'í•˜ì´ë¼ì´íŠ¸ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
    {key:'itinerary',label:'ì¼ì • (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
    {key:'included',label:'í¬í•¨ ì‚¬í•­ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
    {key:'excluded',label:'ë¶ˆí¬í•¨ ì‚¬í•­ (ì¤„ë°”ê¿ˆ êµ¬ë¶„)',type:'textarea'},
    {key:'description',label:'ì„¤ëª…',type:'textarea'}
  ];
  var html = '<button class="btn-back" onclick="loadProducts()">â† ëª©ë¡ìœ¼ë¡œ</button>';
  html += '<div class="inq-detail"><h2>â• ìˆ˜ë™ ìƒí’ˆ ì¶”ê°€</h2>';
  html += '<div style="display:grid;gap:16px;margin-top:16px">';
  fields.forEach(function(f) {
    html += '<div><label style="font-size:13px;font-weight:700;color:var(--gray-700);display:block;margin-bottom:4px">' + f.label + '</label>';
    if (f.type === 'textarea') {
      html += '<textarea id="pf_'+f.key+'" style="width:100%;min-height:80px;padding:10px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px;font-family:inherit;resize:vertical"></textarea>';
    } else {
      html += '<input id="pf_'+f.key+'" type="text" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px">';
    }
    html += '</div>';
  });
  html += '</div>';
  html += '<div style="margin-top:24px"><button class="action-btn btn-approve" style="padding:12px 24px;font-size:14px" onclick="submitNewProduct()">ğŸ’¾ ì €ì¥</button></div>';
  html += '</div>';
  panel.innerHTML = html;
}

function submitNewProduct() {
  var fields = ['title','countryName','city','continent','category','duration','priceFrom','operatorName','image','description','highlights','itinerary','included','excluded'];
  var data = {status:'pending', createdAt:firebase.firestore.FieldValue.serverTimestamp(), updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  fields.forEach(function(f) {
    var el = document.getElementById('pf_'+f);
    if (!el) return;
    var v = el.value;
    if (['highlights','itinerary','included','excluded'].indexOf(f) >= 0) {
      data[f] = v.split('\n').filter(function(l){return l.trim();});
    } else if (f === 'priceFrom') {
      data[f] = parseInt(v) || 0;
    } else {
      data[f] = v;
    }
  });
  if (!data.title) { alert('ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  db.collection('parsed_tours').add(data).then(function() {
    alert('ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    loadProducts();
  }).catch(function(e){alert('ì˜¤ë¥˜: '+e.message);});
}
</script>
